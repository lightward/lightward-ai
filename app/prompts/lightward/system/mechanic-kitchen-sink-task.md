# Mechanic's Kitchen Sink

## Documentation

Welcome to Mechanic's kitchen sink task! This task is designed to showcase a wide range of Mechanic's capabilities, all within a single task. By exploring this task, you should be able to infer and extrapolate the rest of Mechanic's features and functionalities.

This task is structured as follows:

1. Event subscriptions
   - Shopify events
   - Mechanic scheduler events
   - Mechanic error events
   - Custom event subscription behavior using task options
2. Task option configuration
   - Required options
   - Optional options
   - Option types (string, integer, boolean, array)
3. Liquid templating
   - Variable assignment
   - Control flow (if/else, case/when)
   - Looping (for loops)
   - Filtering and transforming data
4. Mechanic actions
   - Shopify API actions
   - HTTP request actions
   - Email actions
   - Cache actions
   - Echo actions
   - Generating logs and errors
5. Responding to action results (mechanic/actions/perform)

Task options:

- shopify_event_topic (required string): A Shopify event topic to subscribe to (e.g., 'shopify/orders/create').
- scheduler_frequency (optional string): A Mechanic scheduler frequency (e.g., '5min', '1hour'). Defaults to '30min'.
- send_email (optional boolean): Whether to send an email action. Defaults to false.
- email_recipients (optional array): An array of email addresses to send the email to.
- cache_key (required string): A cache key to use for storing and retrieving data.

## Subscription template

{% if options.shopify_event_topic__required != blank %}
{{ options.shopify_event_topic__required }}
{% endif %}

{% if options.scheduler_frequency__string != blank %}
mechanic/scheduler/{{ options.scheduler_frequency__string | default: "30min" }}
{% endif %}

mechanic/actions/perform
mechanic/errors/action
mechanic/errors/task

## Code

{% comment %}
SECTION 1: Event handling
{% endcomment %}

{% case event.topic %}
{% when options.shopify_event_topic__required %}
{% assign shopify_event_data = event.data %}
{% log "Received a Shopify event", topic: event.topic, data: shopify_event_data %}

{% when "mechanic/scheduler/" %}
{% log "Received a Mechanic scheduler event", topic: event.topic %}

{% when "mechanic/actions/perform" %}
{% log "Received an action perform event", action: action %}
{% if action.type == "cache" and action.options[0] == "set" %}
{% log "Cache set successfully", key: action.options[1], value: action.options[2] %}
{% endif %}

{% when "mechanic/errors/action" or "mechanic/errors/task" %}
{% log "Received an error event", topic: event.topic, error: event.data %}

{% else %}
{% log "Received an unhandled event", topic: event.topic %}
{% endcase %}

{% comment %}
SECTION 2: Shopify API actions
{% endcomment %}

{% if event.topic == options.shopify_event_topic__required and shopify_event_data.id != blank %}
{% if shopify_event_data.financial_status == "paid" %}
{% action "shopify" %}
mutation {
tagsAdd(id: {{ shopify_event_data.id | json }}, tags: ["paid"]) {
userErrors {
field
message
}
}
}
{% endaction %}
{% endif %}
{% endif %}

{% comment %}
SECTION 3: HTTP request actions
{% endcomment %}

{% if event.topic contains "mechanic/scheduler/" %}
{% action "http" %}
{
"method": "POST",
"url": "https://jsonplaceholder.typicode.com/posts",
"headers": {
"Content-Type": "application/json"
},
"body": {{ options | json }}
}
{% endaction %}
{% endif %}

{% comment %}
SECTION 4: Email actions
{% endcomment %}

{% if options.send_email__boolean %}
{% assign email_recipients = options.email_recipients__array | default: ["admin@example.com"] %}
{% for recipient in email_recipients %}
{% action "email" %}
{
"to": {{ recipient | json }},
"subject": {{ "Test email from Mechanic" | json }},
"body": {{ "This is a test email generated by the kitchen sink task." | json }}
}
{% endaction %}
{% endfor %}
{% endif %}

{% comment %}
SECTION 5: Cache actions
{% endcomment %}

{% assign cache_value = "Cached at " | append: "now" | date: "%Y-%m-%d %H:%M:%S" %}
{% action "cache", "set", options.cache_key__required, cache_value %}

{% comment %}
SECTION 6: Echo actions
{% endcomment %}

{% assign echo_message = "Hello from the kitchen sink task!" %}
{% action "echo", echo_message %}

{% comment %}
SECTION 7: Generating logs and errors
{% endcomment %}

{% if event.topic == "mechanic/scheduler/10min" %}
{% log "This is a debug log" %}
{% log level: "info", message: "This is an info log", details: event %}
{% log level: "warn", message: "This is a warning log" %}

{% if event.preview %}
{% error "This is a test error" %}
{% endif %}
{% endif %}
